<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE  mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="corporationMapper">

	<sql id="whereCorporation">
		<if test="(pStartYear != null and pStartYear != '') or (pEndYear != null and pEndYear != '') ">
			AND A.BSNS_YEAR BETWEEN #{pStartYear} AND #{pEndYear}
		</if>
		<if test=" pCorpCd != null and pCorpCd != '' ">
			AND A.CORP_CODE = #{pCorpCd}
		</if>
		<if test=" curUserId != null and curUserId != ''  ">
			AND A.USER_ID = #{curUserId}
		</if>
	</sql>
	
	<select id="getInterest" parameterType="Map" resultType="HashMap">  
		SELECT 
		    DISTINCT
		    ROUND(SUM(GROWTH) OVER(PARTITION BY CORP_CODE, ACCOUNT_ID ORDER BY ACCOUNT_ID) / COUNT(GROWTH) OVER(PARTITION BY CORP_CODE, ACCOUNT_ID ORDER BY ACCOUNT_ID),2) AS AVR_GROWTH,
		    STOCK_CODE,
		        CORP_NAME,
		        ACCOUNT_ID,
		        CORP_CODE
		FROM
		    (
		    SELECT
		        ROUND((ACC_NET_AMOUNT - LEAD_ACC_NET_AMOUNT) / DECODE(LEAD_ACC_NET_AMOUNT, 0, NULL, LEAD_ACC_NET_AMOUNT) * 100,2) AS GROWTH,
		        STOCK_CODE,
		        CORP_NAME,
		        ACCOUNT_ID,
		        CORP_CODE,
		        BSNS_YEAR,
		        REPRT_CODE,
		        USER_ID
		    FROM
		        (
		            SELECT
		                DENSE_RANK() 
		                OVER(PARTITION BY A.CORP_CODE, REPLACE(A.ACCOUNT_ID, 'ifrs_', 'ifrs-full_') ORDER BY REPLACE(A.ACCOUNT_ID, 'ifrs_', 'ifrs-full_'), A.BSNS_YEAR DESC, A.REPRT_CODE ASC) 
		                AS YEAR_CNT,
		                NVL(A.ACCUMULATED_NET_AMOUNT, 0)             AS ACC_NET_AMOUNT,
		                LEAD(NVL(A.ACCUMULATED_NET_AMOUNT, 0))
		                OVER(PARTITION BY A.CORP_CODE,
		                     REPLACE(A.ACCOUNT_ID, 'ifrs_', 'ifrs-full_')
		                     ORDER BY
		                         A.CORP_CODE,
		                         A.BSNS_YEAR DESC,
		                         A.REPRT_CODE ASC
		                )                                            AS LEAD_ACC_NET_AMOUNT,
		                A.CORP_CODE                                  AS STOCK_CODE,
		                B.CORP_NAME,
		                REPLACE(A.ACCOUNT_ID, 'ifrs_', 'ifrs-full_') AS ACCOUNT_ID,
		                A.BSNS_YEAR,
		                B.CORP_CODE,
		                A.REPRT_CODE,
		                B.USER_ID
		            FROM
		                     TB_BPLC_CIS A
		                INNER JOIN TB_INTEREST B ON A.CORP_CODE = B.STOCK_CODE
		            WHERE
		                    1 = 1
		                AND REPLACE(ACCOUNT_ID, 'ifrs_', 'ifrs-full_') IN ( 'ifrs-full_Revenue', 'dart_OperatingIncomeLoss', 'ifrs-full_ProfitLoss'
		                )
		                AND A.BSNS_YEAR BETWEEN 2016 AND 2022
		                AND A.REPRT_CODE = '11011'
		                AND B.USER_ID = 'SYSTEM_JB'
		            GROUP BY
		                A.CORP_CODE,
		                B.CORP_NAME,
		                REPLACE(A.ACCOUNT_ID, 'ifrs_', 'ifrs-full_'),
		                A.BSNS_YEAR,
		                B.CORP_CODE,
		                A.REPRT_CODE,
		                B.USER_ID,
		                NET_AMOUNT,
		                ACCUMULATED_NET_AMOUNT
		    )
		    WHERE 1=1
		    <![CDATA[
				AND YEAR_CNT < 6
        	]]>
		)    
		WHERE 1=1
			<include refid = "whereCorporation"/>
		ORDER 
		BY STOCK_CODE, (SELECT ORDR FROM TB_CODE_ACCOUNT WHERE CODE = ACCOUNT_ID)
	</select>
	
</mapper>