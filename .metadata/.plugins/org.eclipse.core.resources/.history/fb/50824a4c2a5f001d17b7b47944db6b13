package finance.cms.dart;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URL;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.annotation.Resource;

import org.json.simple.JSONArray;
import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.servlet.ModelAndView;

import finance.cms.dart.service.DartService;
import finance.cms.portfolio.service.PortfolioService;
import finance.common.Controller.CommonController;

@Controller
public class DartController {

	@Autowired
	private DartService dartService;
	
	@Autowired
	private PortfolioService portfolioService;
	
	@Resource(name="CommonController")
	private CommonController commonController;
		
	@RequestMapping(value={"/dart/report/list"} , method = RequestMethod.GET)
	public ModelAndView getDartReportList(@RequestParam Map<String, Object> commandMap) throws Exception {
		SimpleDateFormat format = new SimpleDateFormat("yyyyMMdd");
		Date now = new Date();
		
		Calendar cal = Calendar.getInstance();
		SimpleDateFormat sdf = new SimpleDateFormat("yyyyMMdd");
		cal.add(cal.YEAR, -2); //세달 전
		
		String bgndate = sdf.format(cal.getTime());
		String endDate = format.format(now);
		String corpCd = commandMap.get("corpCd").toString();
		
		
		String infoURL = "https://opendart.fss.or.kr/api/list.json?";
		String crtfcKey = "fb1e1e5223c66ce1175f545ddd0ea9a15984528a";
		
		List<Map<String, Object>> getDartReportList = new ArrayList<Map<String, Object>> ();
		try{
			URL url = new URL(infoURL+"crtfc_key="+crtfcKey+"&corp_code="+corpCd+"&bgn_de="+bgndate+"&end_de="+endDate+"&page_no=1&page_count=100" );
			HttpURLConnection conn = (HttpURLConnection) url.openConnection();
			conn.setRequestMethod("GET");
			conn.setRequestProperty("Content-type", "application/json");
			System.out.println("url : "+url);
			StringBuffer sb = new StringBuffer();
			BufferedReader br = new BufferedReader(new InputStreamReader(conn.getInputStream(), "UTF-8"));
			while(br.ready()) {
				sb.append(br.readLine());
			}
			JSONObject objData = (JSONObject)new JSONParser().parse(sb.toString());
			JSONArray infoList = (JSONArray) objData.get("list");
			if(infoList != null) {
				for(int j=0; j < infoList.size(); j++) {
		            JSONObject infoObject = (JSONObject) infoList.get(j);
		            Map<String, Object> paramMap = new HashMap<String, Object>();
					
		            String corp_name = infoObject.get("corp_name").toString();
		            String report_nm = infoObject.get("report_nm").toString();
		            String rcept_no = infoObject.get("rcept_no").toString();
		            String flr_nm = infoObject.get("flr_nm").toString();
		            String rcept_dt = infoObject.get("rcept_dt").toString();
		            
		            paramMap.put("SEQ", j+1);
		            paramMap.put("CORP_NM", corp_name);
		            paramMap.put("REPRT_NM", report_nm);
		            paramMap.put("REPRT_NO", rcept_no);
		            paramMap.put("FLR_NM", flr_nm);
		            paramMap.put("REPORT_DT", rcept_dt);
		            
		            System.out.println("JB : "+paramMap.toString());		            	            
		            getDartReportList.add(j, paramMap);
		            System.out.println("JB : "+getDartReportList.toString());
		        }
			}
			
		}catch(Exception e) {
			e.printStackTrace();
		}
			 
		JSONArray getDartReportJson = commonController.convertListToJson(getDartReportList);
		
		System.out.println("JB 끝 : "+ getDartReportJson.toString());
		
		
		
	    ModelAndView mav = new ModelAndView();
	    String resultURL = "dart/dartReportList";
	    mav.addObject("getDartReportJson", getDartReportJson);
	    mav.setViewName(resultURL);
	    
	    return mav;
	}
}
